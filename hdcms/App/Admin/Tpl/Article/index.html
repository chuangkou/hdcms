<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <css file="__STATIC__/Css/common.css"/>
    <css file="__CONTROL_TPL__/Css/article.css"/>
    <title>文章列表</title>
    <jquery/>
    <jsconst/>
    <hdui/>
    <script>
        //全选或反选
        $(function () {
            $("input[name='select_all']").click(function () {
                if ($(this).attr("checked")) {
                    $("input[name='aids[]']").attr("checked", "checked");
                } else {
                    $("input[name='aids[]']").removeAttr("checked");
                }
            })
        })
        /**
         * 删除文章
         * @param aid 文章id
         */
        function delArticle(aid) {
            if (aid) {//删除单篇文章
                aids = {'aids[]': aid};
            } else {//批量删除
                var aids = $("input[name='aids[]']").serialize();
            }
            $.post("__CONTROL__&m=del&mid={$hd.get.mid}", aids, function (data) {
                if (data) {
                    alert("文章删除成功");
                    location.href = data.url;
                } else {
                    alert("文章删除失败");
                }
                location.reload(true);
            })
            return false;
        }
        //搜索
        $(function () {
            $("#searchForm").submit(function () {
                var url = "{|U:'index',array('mid'=>$_GET['mid'])}";
                $(this).find("[name]").each(function (i) {
                    var val = $(this).val();
                    if (val) {
                        url += "&" + $(this).serialize();
                    }
                })
                location.href = url;
                return false;
            })
        })
        //更改排序
        function setArcSort() {
            var data = $("[name^=arc_sort]").serialize();
            data += "&mid={$hd.get.mid}";
            $.post("{|U:'setArcSort'}", data, function (data) {
                if (data == 1) {
                    window.location.reload(true);
                }
            })
        }
    </script>
</head>
<body>
<div class="search">
    <form action="{|U:'index',array('mid'=>$_GET['mid'])}" id="searchForm">
        <ul>
            <li>
                <select name="search[cid]">
                    <option value="">==栏目==</option>
                    <list from="$category" name="d">
                        <option value="{$d.cid}">{$d.catname}</option>
                    </list>
                </select>
            </li>
            <li>
                标题: <input type="text" name="search[title]" class="w100"/>
            </li>
            <li>
                <select name="search[rid]">
                    <option value="">==角色==</option>
                    <list from="$role" name="r">
                        <option value="{$r.rid}">{$r.rname}</option>
                    </list>
                </select>
            </li>
            <li>
                作者: <input type="text" name="username" class="w80"/>
            </li>
            <li>
                <select name="order">
                    <option value="">===排序===</option>
                    <option value="updatetime">修改时间</option>
                    <option value="click">点击次数</option>
                </select>
            </li>
            <li>
                属性:
                <select name="search[fid]">
                    <option value="">===属性===</option>
                    <list from="$flag" name="f">
                        <option value="{$f.fid}">{$f.flagname}</option>
                    </list>
                </select>
            </li>
            <li>
                <input type="submit" value="搜索" class="btn1"/>
            </li>
        </ul>
    </form>
</div>
<div class="right_content">
    <div class="menu">
        <a href="{|U:'index',array('mid'=>$_GET['mid'])}" class="action">全部内容</a> <span>|</span>
        <a href="{|U:add,array('mid'=>$_GET['mid'])}">添加文章</a>
    </div>
    <div class="content">
        <table class="table table-title">
            <thead>
            <tr>
                <td width="30"><input type="checkbox" name="select_all"/></td>
                <td width="30">id</td>
                <td width="30">排序</td>
                <td>标题</td>
                <td width="120">所属栏目</td>
                <td width="120">更新时间</td>
                <td width="50">点击</td>
                <td width="120">发布人</td>
                <td width="100">操作</td>
            </tr>
            </thead>
            <tbody>
            <list from="$data" name="d">
                <tr>
                    <td><input type="checkbox" name="aids[]" value="{$d.aid}"/></td>
                    <td>{$d.aid}</td>
                    <td>
                        <input type="text" name="arc_sort[{$d.aid}]" value="{$d.arc_sort}"
                               style="width:30px;padding:0px 3px;"/>
                    </td>
                    <td>
                        <a href="{|U:'Index/Index/article',array('aid'=>$d['aid'],'mid'=>$d['mid'],'cid'=>$d['cid'])}"
                           target="_blank">{$d.title|mb_substr:0,20,"utf-8"}</a>
                        <span>
                            {|getArticleFlag:$d['aid'],$d['cid'],$d['mid']}
                        </span>
                    </td>
                    <td>
                        <a href="{|U:'index',array('search[cid]'=>$d['cid'],'mid'=>$d['mid'])}">
                            {$d.catname}
                        </a>
                    </td>
                    <td>{$d.updatetime|date:"Y-m-d h:i",@@}</td>
                    <td>{$d.click}</td>
                    <td>
                        <a href="{|U:'index',array('author'=>$d['username'],'mid'=>$d['mid'],'username'=>$d['username'])}">{$d.username}</a>
                        <a href="{|U:'index',array('search[rid]'=>$d['rid'],'mid'=>$d['mid'])}">({$d.rname})</a>
                    </td>
                    <td>
                        <a href="{|U:'Index/Index/article',array('aid'=>$d['aid'],'mid'=>$d['mid'],'cid'=>$d['cid'])}"
                           target="_blank">预览</a> |
                        <a href="{|U:'edit',array('aid'=>$d['aid'],'mid'=>$d['mid'],'cid'=>$d['cid'],'rid'=>$d['rid'])}">修改</a>
                        |
                        <a href="javascript:;"
                           onclick="return confirm('确定删除文章【{$d.title}】吗？')?delArticle({$d.aid}):false">删除</a>
                    </td>
                </tr>
            </list>
            </tbody>
        </table>
    </div>
    <?php if(!empty($data)):?>
    <div style="float:left; margin-top:20px;">
        <input type="button" class="btn1" onclick="return confirm('确定删除文章吗？')?delArticle():false;" value="删除"/>
        <input type="button" class="btn1" onclick="setArcSort()" value="排序"/>
    </div>
    <div class="page1">
        {$page}
    </div>
    <?php endif;?>
</div>
</body>
</html>